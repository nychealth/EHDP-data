###########################################################################################-
###########################################################################################-
##
## Update views and stored procedures in database
##
###########################################################################################-
###########################################################################################-

#-----------------------------------------------------------------------------------------#
# setup
#-----------------------------------------------------------------------------------------#

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# get parent dir for absolute path
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

$base_dir = Get-Location

$Env:base_dir = $base_dir

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# source script to set environment params
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

. $base_dir\export-scripts\set_environment.ps1

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# set database name
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

if ($Env:data_env -eq "s") {

    $db_name = "BESP_IndicatorAnalysis"

} elseif ($Env:data_env -eq "p") {

    $db_name = "BESP_Indicator"

}


#=========================================================================================#
# run updates
#=========================================================================================#

#-----------------------------------------------------------------------------------------#
# get file names
#-----------------------------------------------------------------------------------------#

$views = Get-ChildItem -Path $base_dir\export-scripts\SQL-Server-DB-views

#-----------------------------------------------------------------------------------------#
# update database using `sqlcmd`
#-----------------------------------------------------------------------------------------#

foreach($v in $views) {

    Write-Host "-------------------------------------------------------------"
    Write-Host $v.Name
    Write-Host "- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -"

    Invoke-Sqlcmd -ServerInstance $Env:server -Database $db_name -TrustServerCertificate -OutputSqlErrors $true -InputFile $v.FullName

}


# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# #
# #                             ---- THIS IS THE END! ----
# #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
