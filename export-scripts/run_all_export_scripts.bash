#!/bin/bash

###########################################################################################-
###########################################################################################-
##
## Running all data export scripts
##
###########################################################################################-
###########################################################################################-

#-----------------------------------------------------------------------------------------#
# setup
#-----------------------------------------------------------------------------------------#

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# get parent dir for absolute path
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

export base_dir=$(pwd)

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Set the server based on the computer name
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

if [ "$HOSTNAME" == "DESKTOP-PU7DGC1" ]; then
    export server="DESKTOP-PU7DGC1"
else
    export server="SQLIT04A"
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Choose database to use
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

read -p "staging [s] or production [p]? " data_env
export data_env="${data_env,,}"  # Convert to lowercase

# Make sure you're on the right branch

current_branch=$(git branch --show-current)

if [[ "$data_env" == "s" ]] && [[ "$current_branch" != "staging" ]]; then
    read -p "Switch to staging? Yes [y] / No [n] " switch
    switch="${switch,,}"  # Convert to lowercase

    if [[ "$switch" == "y" ]]; then
        git checkout staging
        git pull
    fi

elif [[ "$data_env" == "p" ]] && [[ "$current_branch" != "production" ]]; then
    read -p "Switch to production? Yes [y] / No [n] " switch
    switch="${switch,,}"  # Convert to lowercase

    if [[ "$switch" == "y" ]]; then
        git checkout production
        git pull
    fi
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Tell conda which environment to load
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

# conda activate EHDP-data

#=========================================================================================#
# R
#=========================================================================================#

#-----------------------------------------------------------------------------------------#
# EXP data
#-----------------------------------------------------------------------------------------#

echo ">>> EXP_indicator_data_writer"
Rscript "$base_dir/export-scripts/EXP_indicator_data_writer.R"

#-----------------------------------------------------------------------------------------#
# EXP metadata
#-----------------------------------------------------------------------------------------#

echo ">>> EXP_indicator_metadata_writer"
Rscript $base_dir/export-scripts/EXP_indicator_metadata_writer.R

#-----------------------------------------------------------------------------------------#
# EXP comparisons metadata
#-----------------------------------------------------------------------------------------#

echo ">>> EXP_measure_comparisons_writer"
Rscript "$base_dir/export-scripts/EXP_measure_comparisons_writer.R"

#-----------------------------------------------------------------------------------------#
# NR viz data (for VegaLite)
#-----------------------------------------------------------------------------------------#

echo ">>> NR_data_csv_writer"
Rscript "$base_dir/export-scripts/NR_data_csv_writer.R"

#-----------------------------------------------------------------------------------------#
# NR JSON data (for report)
#-----------------------------------------------------------------------------------------#

echo ">>> NR_json_writer"
Rscript "$base_dir/export-scripts/NR_json_writer.R"

#-----------------------------------------------------------------------------------------#
# GeoLookup
#-----------------------------------------------------------------------------------------#

# echo ">>> create_GeoLookup"
# Rscript "$base_dir/export-scripts/create_GeoLookup.R"

#=========================================================================================#
# Python
#=========================================================================================#

#-----------------------------------------------------------------------------------------#
# EXP metadata
#-----------------------------------------------------------------------------------------#

# echo ">>> EXP_indicator_metadata_writer"
# python "$base_dir/export-scripts/EXP_indicator_metadata_writer.py"

#-----------------------------------------------------------------------------------------#
# NR spark bars
#-----------------------------------------------------------------------------------------#

# echo ">>> NR_SparkBarExport"
# python "$base_dir/export-scripts/NR_SparkBarExport.py"

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# #
# #                             ---- THIS IS THE END! ----
# #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
